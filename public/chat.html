<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Chat</title>
  <link id="themeStylesheet" rel="stylesheet" href="theme-classic.css" />
  <style>
    body {
      font-family: monospace;
      padding: 1rem;
      margin: 0 auto;
      max-width: 600px;
      font-size: 18px;
      line-height: 1.4;
      background: var(--bg);
      color: var(--fg);
    }
    a { color: var(--link); }
    pre { height: 60vh; overflow-y: auto; white-space: pre-wrap; border: 1px solid var(--border); padding: 0.5rem; }
    .char { color: deepskyblue; }
    .location { color: violet; }
    .item { color: gold; }
    .spell { color: orchid; }
    .monster { color: tomato; }
    .gold { color: khaki; }
    input { width: 100%; font-size: 18px; margin-top: 0.5rem; background: var(--accent-bg); color: var(--accent-fg); border: 1px solid var(--border); }
    #themeSelect { margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <label for="themeSelect">Theme:</label>
  <select id="themeSelect">
    <option value="classic">Classic</option>
    <option value="bw">Black & White</option>
    <option value="modern">Modern</option>
  </select>
  <pre id="log"></pre>
  <pre id="readyBox"></pre>
  <input id="chatInput" placeholder="message" autocomplete="off" />
  <p><a href="player.html">&#x2B05; Back</a></p>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const sel = document.getElementById('themeSelect');
    const saved = localStorage.getItem('theme') || 'classic';
    sel.value = saved;
    document.getElementById('themeStylesheet').href = `theme-${saved}.css`;
    sel.onchange = () => {
      const t = sel.value;
      localStorage.setItem('theme', t);
      document.getElementById('themeStylesheet').href = `theme-${t}.css`;
    };
    const socket = io();
    const logEl = document.getElementById('log');
    const readyBox = document.getElementById('readyBox');
    const input = document.getElementById('chatInput');
    const name = localStorage.getItem('characterName') || 'Anon';

    function colorize(text) {
      return text
        .replace(/#([\w ]+)/g, '<span class="item">#$1</span>')
        .replace(/\$(\d+)/g, '<span class="gold">$$$1</span>')
        .replace(/@([\w ]+)/g, '<span class="char">@$1</span>')
        .replace(/&([\w ]+)/g, '<span class="location">&$1</span>')
        .replace(/!([\w ]+)/g, '<span class="spell">!$1</span>')
        .replace(/%([\w ]+)/g, '<span class="monster">%$1</span>');
    }

    socket.emit('getCampaignLog');
    socket.emit('registerPlayer', name);
    socket.on('campaignLog', (log) => {
      logEl.innerHTML = log.map(colorize).join('<br>');
    });
    socket.on('logUpdate', (entry) => {
      logEl.innerHTML += '<br>' + colorize(entry);
      logEl.scrollTop = logEl.scrollHeight;
    });
    socket.on('readyList', (list) => {
      readyBox.textContent = Object.entries(list)
        .map(([n, r]) => `${r ? '[READY]' : '[    ]'} ${n}`)
        .join('\n');
    });
    function roll(expr) {
      const m = expr.match(/(\d*)d(\d+)([+-]\d+)?/i);
      if (!m) return null;
      const num = parseInt(m[1] || '1', 10);
      const sides = parseInt(m[2], 10);
      const mod = parseInt(m[3] || '0', 10);
      let total = 0;
      const rolls = [];
      for (let i = 0; i < num; i++) {
        const r = Math.floor(Math.random() * sides) + 1;
        rolls.push(r);
        total += r;
      }
      total += mod;
      return { total, detail: `${rolls.join(' + ')}${mod ? (mod>0? ' +' + mod: ' ' + mod) : ''}` };
    }

    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && input.value.trim()) {
        const text = input.value.trim();
        if (text === '/ready') {
          socket.emit('playerReady', true);
          input.value = '';
          return;
        }
        if (text === '/unready') {
          socket.emit('playerReady', false);
          input.value = '';
          return;
        }
        if (text.startsWith('/roll ')) {
          const expr = text.slice(6);
          const res = roll(expr);
          if (res) {
            const msg = `${name} rolls ${expr}: ${res.total} (${res.detail})`;
            socket.emit('playerMessage', { name, message: msg });
          }
          input.value = '';
          return;
        }
        socket.emit('playerMessage', { name, message: text });
        input.value = '';
      }
    });
  </script>
</body>
</html>
