<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Sheet</title>
  <style>
    body {
      background: black;
      color: lime;
      font-family: monospace;
      padding: 1rem;
      margin: 0 auto;
      max-width: 600px;
      font-size: 18px;
      line-height: 1.4;
    }
    a { color: #00ffcc; }
    input, button {
      background: black;
      color: lime;
      border: 1px solid lime;
      font-family: monospace;
    }
  </style>
</head>
<body>
  <div id="charDisplay">Loading...</div>
  <p><a href="player.html">&#x2B05; Back</a></p>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const display = document.getElementById('charDisplay');
    const socket = io();
    const name = localStorage.getItem('characterName');
    if (name) {
      socket.emit('loadCharacter', name);
    } else {
      display.textContent = 'No character found.';
    }

    function encumbrance(char) {
      let slots = (char.inventory || []).length;
      const coins = char.gold || 0;
      slots += Math.ceil(coins / 100);
      if (char.inventory.includes('Plate Mail')) slots += 5;
      if (char.inventory.includes('Chain Mail')) slots += 4;
      if (char.inventory.includes('Leather Armor')) slots += 2;
      if (char.inventory.includes('Shield')) slots += 1;
      let mv;
      if (slots <= 5) mv = '120\'';
      else if (slots <= 10) mv = '90\'';
      else if (slots <= 15) mv = '60\'';
      else mv = '30\'';
      return { slots, mv };
    }

    let currentChar = null;
    socket.on('characterLoaded', (charData) => {
      currentChar = charData;
      if (!currentChar.nameColor) currentChar.nameColor = '#00bfff';
      if (!currentChar.nameFont) currentChar.nameFont = 'monospace';
      const s = charData.stats || {};
      const fonts = ['monospace','serif','sans-serif','cursive','fantasy'];
      const fontOptions = fonts.map(f =>
        `<option value="${f}"${currentChar.nameFont===f?' selected':''}>${f}</option>`
      ).join('');
      display.innerHTML =
        `<strong id="previewName" style="color:${currentChar.nameColor}; font-family:${currentChar.nameFont}">${charData.name}</strong><br>` +
        `Class: ${charData.class} ${charData.alignment}<br>` +
        `Career: ${charData.career || ''}<br>` +
        `STR:${s.STR} DEX:${s.DEX} CON:${s.CON} INT:${s.INT} WIS:${s.WIS} CHA:${s.CHA}<br>` +
        `HP:<input id="hpInput" type="number" value="${charData.hp}" style="width:60px"> ` +
        `AC:${charData.ac} ` +
        `XP:<input id="xpInput" type="number" value="${charData.xp}" style="width:80px">/${charData.nextLevelXP}<br>` +
        (() => {
          const enc = encumbrance(charData);
          return `ENC:${enc.slots} MV:${enc.mv}<br>`;
        })() +
        `Name Color: <input id="colorInput" type="color" value="${currentChar.nameColor}"><br>` +
        `Name Font: <select id="fontSelect">${fontOptions}</select><br>` +
        `<button id="saveBtn">Save</button>`;

      const colorInput = document.getElementById('colorInput');
      const fontSelect = document.getElementById('fontSelect');
      colorInput.oninput = () => {
        document.getElementById('previewName').style.color = colorInput.value;
      };
      fontSelect.onchange = () => {
        document.getElementById('previewName').style.fontFamily = fontSelect.value;
      };

      document.getElementById('saveBtn').onclick = () => {
        currentChar.hp = parseInt(document.getElementById('hpInput').value, 10);
        currentChar.xp = parseInt(document.getElementById('xpInput').value, 10);
        currentChar.nameColor = colorInput.value;
        currentChar.nameFont = fontSelect.value;
        socket.emit('saveCharacter', currentChar);
        alert('Character saved');
      };
    });
  </script>
</body>
</html>
