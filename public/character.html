<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Character Sheet</title>
  <link rel="stylesheet" href="theme-dark.css" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Tiny5&family=Jacquard+12&family=Jacquarda+Bastarda+9&family=Jacquard+24&display=swap">
  <style>
    body {
      font-family: 'Tiny5', monospace;
      padding: 1rem;
      margin: 0 auto;
      max-width: 100%;
      font-size: 16px;
      line-height: 1.4;
      background: var(--bg);
      color: var(--fg);
    }
    a { color: var(--link); }
    input, button {
      background: var(--accent-bg);
      color: var(--accent-fg);
      border: 1px solid var(--border);
      font-family: 'Tiny5', monospace;
    }
  </style>
</head>
<body>
  <div id="charDisplay">Loading...</div>
  <div id="charIcon" style="font-size:30px;margin-top:0.5rem;"></div>
  <p><a href="player.html">&#x2B05; Back</a></p>

  <script src="/socket.io/socket.io.js"></script>
  <script>

    const display = document.getElementById('charDisplay');
    const socket = io();
    const params = new URLSearchParams(window.location.search);
    const name = params.get('n') || localStorage.getItem('characterName');
    const dmMode = params.has('dm');
    if (name) {
      socket.emit('loadCharacter', name);
    } else {
      display.textContent = 'No character found.';
    }

    function encumbrance(char) {
      let slots = (char.inventory || []).length;
      const coins = char.gold || 0;
      slots += Math.ceil(coins / 100);
      if (char.inventory.includes('Plate Mail')) slots += 5;
      if (char.inventory.includes('Chain Mail')) slots += 4;
      if (char.inventory.includes('Leather Armor')) slots += 2;
      if (char.inventory.includes('Shield')) slots += 1;
      let mv;
      if (slots <= 5) mv = '120\'';
      else if (slots <= 10) mv = '90\'';
      else if (slots <= 15) mv = '60\'';
      else mv = '30\'';
      return { slots, mv };
    }

    const xpTable = {
      Fighter: [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000],
      Cleric: [0, 1500, 3000, 6000, 12000, 24000, 48000, 90000, 180000, 270000],
      'Magic-User': [0, 2500, 5000, 10000, 20000, 40000, 80000, 150000, 300000, 450000],
      Thief: [0, 1200, 2400, 4800, 9600, 20000, 40000, 70000, 110000, 160000],
      Assassin: [0, 1200, 2400, 4800, 9600, 20000, 40000, 70000, 110000, 160000],
      Barbarian: [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000],
      Bard: [0, 1200, 2400, 4800, 9600, 20000, 40000, 70000, 110000, 160000],
      Druid: [0, 1500, 3000, 6000, 12000, 24000, 48000, 90000, 180000, 270000],
      Illusionist: [0, 2500, 5000, 10000, 20000, 40000, 80000, 150000, 300000, 450000],
      Knight: [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000],
      Paladin: [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000],
      Ranger: [0, 2000, 4000, 8000, 16000, 32000, 64000, 120000, 240000, 360000]
    };
    const hitDie = {
      Fighter: 8,
      Cleric: 6,
      'Magic-User': 4,
      Thief: 4,
      Assassin: 4,
      Barbarian: 8,
      Bard: 4,
      Druid: 6,
      Illusionist: 4,
      Knight: 8,
      Paladin: 8,
      Ranger: 8
    };

    const titles = {
      Fighter: ['Veteran','Warrior','Swordmaster','Hero','Swashbuckler','Myrmidon','Champion','Superhero','Lord'],
      Cleric: ['Acolyte','Adept','Priest','Vicar','Curate','Bishop','Lama','Patriarch','High Priest'],
      'Magic-User': ['Medium','Seer','Conjurer','Theurgist','Thaumaturge','Magician','Enchanter','Warlock','Sorcerer','Wizard'],
      Thief: ['Rogue','Footpad','Robber','Burglar','Cutpurse','Sharper','Pilferer','Thief','Master Thief'],
      Assassin: ['Rogue','Footpad','Killer','Murderer','Executioner','Slayer','Shadow','Assassin','Master Assassin'],
      Barbarian: ['Brute','Rager','Marauder','Raider','Berserker','Warlord','Chieftain','Barbarian Lord'],
      Bard: ['Minstrel','Lyrist','Raconteur','Troubadour','Skald','Muse','Virtuoso','Maestro'],
      Druid: ['Adept','Naturalist','Initiate','Seer','Shaman','Druid','High Druid','Great Druid'],
      Illusionist: ['Prestidigitator','Illusionist','Mirage Maker','Visionist','Phantasmist','Trickster','Master Illusionist'],
      Knight: ['Squire','Cavalier','Chevalier','Lancer','Banneret','Knight','Champion','Paladin','Lord'],
      Paladin: ['Gallant','Keeper','Ward','Justicar','Crusader','Paladin','Holy Paladin','Templar','Lord'],
      Ranger: ['Runner','Scout','Pathfinder','Guide','Warden','Ranger','Guardian','Avenger','Ranger Lord']
    };

    function getTitle(cls, lvl) {
      const list = titles[cls];
      if (!list) return '';
      return list[Math.min(lvl - 1, list.length - 1)];
    }

    function checkLevelUp(char) {
      while (char.xp >= char.nextLevelXP) {
        char.level = (char.level || 1) + 1;
        const hd = hitDie[char.class] || 6;
        char.hp += Math.floor(Math.random() * hd) + 1;
        const next = xpTable[char.class][char.level] || Infinity;
        char.nextLevelXP = next;
      }
    }

    let currentChar = null;
    socket.on('characterLoaded', (charData) => {
      currentChar = charData;
      const s = charData.stats || {};
      const statusList = charData.status || [];
      const statusHtml = statusList.length
        ? statusList
            .map((s) =>
              dmMode ? `${s} <button data-s="${s}" class="rm">x</button>` : s
            )
            .join(', ')
        : '(none)';
      display.innerHTML =
        `<strong>${charData.name}</strong><br>` +
        `Class: <a href="classinfo.html?c=${encodeURIComponent(charData.class)}" target="_blank">${charData.class}</a> ${charData.alignment} Level ${charData.level}<br>` +
        `Title: ${getTitle(charData.class, charData.level)}<br>` +
        `Career: ${charData.career || ''}<br>` +
        (charData.homeTown && charData.homeTown.name ? `Hometown: ${charData.homeTown.name}<br>` : '') +
        (charData.motivation ? `Motivation: ${charData.motivation}<br>` : '') +
        (charData.favoriteFood ? `Favorite Food: ${charData.favoriteFood}<br>` : '') +
        (charData.languages ? `Languages: ${charData.languages.join(', ')}<br>` : '') +
        `STR:${s.STR} DEX:${s.DEX} CON:${s.CON} INT:${s.INT} WIS:${s.WIS} CHA:${s.CHA}<br>` +
        `HP:<input id="hpInput" type="number" value="${charData.hp}" style="width:60px"> ` +
        `AC:${charData.ac} ` +
        `XP:<input id="xpInput" type="number" value="${charData.xp}" style="width:80px">/${charData.nextLevelXP}<br>` +
        `Active Status: ${statusHtml}<br>` +
        `<button id="saveBtn">Save</button>`;

      const iconEl = document.getElementById('charIcon');
      iconEl.textContent = (charData.class || '?')[0].toUpperCase();
      iconEl.style.color = charData.color || '#fff';

      document.getElementById('saveBtn').onclick = () => {
        currentChar.hp = parseInt(document.getElementById('hpInput').value, 10);
        currentChar.xp = parseInt(document.getElementById('xpInput').value, 10);
        checkLevelUp(currentChar);
        socket.emit('saveCharacter', currentChar);
        alert('Character saved');
      };

      if (dmMode) {
        document.querySelectorAll('.rm').forEach((btn) => {
          btn.onclick = () => {
            const stat = btn.getAttribute('data-s');
            socket.emit('removeStatus', { name: charData.name, status: stat });
          };
        });
      }
    });
  </script>
</body>
</html>
